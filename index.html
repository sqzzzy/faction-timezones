<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Faction Timezones Map</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      background: #111;
      font-family: Arial, sans-serif;
      color: white;
    }

    /* === Desktop Map === */
    #map-wrapper {
      width: 100%;
      max-width: 1000px;
      aspect-ratio: 1327 / 768;
      position: relative;
      touch-action: none;
      margin: 0 auto;
    }

    #map-container {
      background: url('Classicvirgin-Time-Zones-May-2025.png') no-repeat center center;
      background-size: cover;
      width: 100%;
      height: 100%;
      position: relative;
      overflow: visible;
      image-rendering: crisp-edges;
    }

    #dayNightCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    #map-footer,
    #country-counter,
    #faction-logo {
      position: absolute;
      z-index: 5;
    }

    #map-footer {
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 24px;
      background: rgba(0, 0, 0, 0.5);
      padding: 6px 14px;
      border-radius: 10px;
      box-shadow: 0 0 8px #ffbe3d;
    }

    #country-counter {
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 13px;
    }

    #country-counter ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #country-counter li {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    #country-counter li.country-total {
      border-top: 1px solid #ffbe3d;
      margin-top: 6px;
      padding-top: 4px;
      font-weight: bold;
    }

    #faction-logo {
      bottom: 20px;
      right: 20px;
    }

    #faction-logo img {
      height: 120px;
      filter: drop-shadow(8px 6px 4px rgba(0, 0, 0, 0.9));
    }

    /* === Mobile Header (Sticky) === */
    #mobile-header {
      background: #ff9e1b;
      color: white;
      font-family: 'Orbitron', sans-serif;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
    }

    #mobile-header img {
      width: 50px;
      flex-shrink: 0;
      filter: drop-shadow(4px 4px 2px rgba(0,0,0,0.7));
    }

    #mobile-header h1 {
      font-size: 18px;
      margin: 0;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* === Mobile Country Counter === */
    #mobile-country-counter {
      background: #111;
      color: #ffbe3d;
      padding: 12px 16px;
      font-size: 14px;
    }

    #mobile-country-counter h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    #mobile-country-counter ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #mobile-country-counter li {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    #mobile-timezone-list {
      background: #111;
      padding: 10px 16px 80px;
      overflow-y: auto;
      height: calc(100dvh - 100px);
    }

    #mobile-timezone-list ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #mobile-timezone-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #333;
      font-size: 17px;
      gap: 4px;
    }

    #mobile-timezone-list li .name {
      flex-grow: 1;
      margin-left: 8px;
    }

    #mobile-timezone-list li .time {
      color: #ffbe3d;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      white-space: nowrap;
    }

    #mobile-timezone-list li.torn-time {
      background: #ffbe3d;
      color: white;
      font-weight: bold;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 0 10px #ffbe3d;
    }

    #mobile-timezone-list li.torn-time .time {
      color: white;
    }

    @media (max-width: 768px) {
      #map-wrapper,
      #country-counter,
      #map-footer,
      #faction-logo {
        display: none;
      }

      #mobile-header,
      #mobile-timezone-list,
      #mobile-country-counter {
        display: block;
      }
    }
  </style>
</head>
<body>

  <!-- Mobile Header -->
  <div id="mobile-header">
    <img src="Logo.png" alt="Faction Logo" />
    <h1>Classicvirgin Time Zones</h1>
  </div>

  <!-- Mobile Country Counter -->
  <div id="mobile-country-counter">
    <h3>Members by Country</h3>
    <ul id="country-list"></ul>
  </div>

  <!-- Mobile Timezone List -->
  <div id="mobile-timezone-list">
    <ul id="timezone-list"></ul>
  </div>

  <!-- Desktop View -->
  <div id="map-wrapper">
    <div id="map-container">
      <canvas id="dayNightCanvas"></canvas>
    </div>
    <div id="map-footer">Classicvirgin Time Zones</div>
    <div id="country-counter">
      <h3>Members by Country</h3>
      <ul id="country-list"></ul>
    </div>
    <div id="faction-logo">
      <img src="Logo.png" alt="Faction Logo" />
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/panzoom@9.4.0/dist/panzoom.min.js"></script>
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
  <script>
    const isMobile = window.innerWidth <= 768;

    async function loadMarkers() {
      const container = document.getElementById("map-container");
      const people = await fetch("people.json").then(res => res.json());
      const countryCounts = {};
      const timezoneList = document.getElementById("timezone-list");

      const sortedPeople = [
        { name: "Torn Time", timezone: "UTC", flag: "clock", left: "43%" },
        ...people
      ].sort((a, b) => parseFloat(a.left) - parseFloat(b.left));

      for (const p of sortedPeople) {
        const peopleCount = p.name.split("<br>").length;

        if (p.flag !== 'clock') {
          countryCounts[p.flag] = (countryCounts[p.flag] || 0) + peopleCount;
        }

        if (!isMobile) {
          const div = document.createElement("div");
          div.className = "marker";
          div.style.top = p.top || '0%';
          div.style.left = p.left;
          div.dataset.timezone = p.timezone;
          container.appendChild(div);
        } else {
          const names = p.name.split("<br>");
          names.forEach(name => {
            const li = document.createElement("li");
            if (p.flag === 'clock') li.classList.add('torn-time');
            li.innerHTML = `
              <span>${p.flag === 'clock' ? 'ðŸ•’' : `<img src='flags/${p.flag}.png' width='18'>`}</span>
              <span class="name">${name}</span>
              <span class="time" data-tz="${p.timezone}">--:--:--</span>
            `;
            timezoneList.appendChild(li);
          });
        }
      }

      // Country Counters
      const lists = document.querySelectorAll("#country-list");
      lists.forEach(list => {
        list.innerHTML = '';
        let total = 0;
        Object.entries(countryCounts).sort((a, b) => b[1] - a[1]).forEach(([flag, count]) => {
          total += count;
          const li = document.createElement("li");
          li.innerHTML = `
            <span><img src="flags/${flag}.png" style="width: 16px; vertical-align: middle;"> ${flag.toUpperCase()}</span>
            <span>${count}</span>`;
          list.appendChild(li);
        });
        const totalLi = document.createElement("li");
        totalLi.className = "country-total";
        totalLi.innerHTML = `<strong>Total</strong><strong>${total}</strong>`;
        list.appendChild(totalLi);
      });
    }

    function updateTimes() {
      document.querySelectorAll(".time").forEach(el => {
        const tz = el.dataset.tz;
        try {
          const formatted = new Intl.DateTimeFormat("en-GB", {
            timeZone: tz,
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false
          }).format(new Date());
          el.textContent = formatted;
        } catch {}
      });
    }

    function updateDayNightShading() {
      if (isMobile) return;
      const canvas = document.getElementById('dayNightCanvas');
      const ctx = canvas.getContext('2d');
      const width = canvas.width = canvas.offsetWidth;
      const height = canvas.height = canvas.offsetHeight;
      ctx.clearRect(0, 0, width, height);
      const now = new Date();
      const latMin = -90, latMax = 90;
      const lonMin = -180, lonMax = 180;
      const step = 1;
      const twilightCutoff = -11 * (Math.PI / 180);

      for (let y = 0; y < height; y += step) {
        const lat = latMax - (y / height) * (latMax - latMin);
        for (let x = 0; x < width; x += step) {
          const lon = lonMin + (x / width) * (lonMax - lonMin);
          const sunPos = SunCalc.getPosition(now, lat, lon);
          if (sunPos.altitude < twilightCutoff) {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
            ctx.fillRect(x, y, step, step);
          }
        }
      }
    }

    loadMarkers();
    updateTimes();
    setInterval(updateTimes, 1000);
    updateDayNightShading();
    setInterval(updateDayNightShading, 300000);
  </script>
</body>
</html>